<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pedidos</title>
    <!-- Integración de Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">
    <div class="container my-5">
        <h1 class="text-center mb-4">Gestión de Pedidos</h1>
        
        <!-- Formulario para agregar un nuevo pedido -->
        <div class="card p-4 mb-4">
            <h2 class="h5">Agregar Nuevo Pedido</h2>
            <form id="add-order-form" class="row g-3">
                <div class="col-md-6">
                    <label for="add-order-name" class="form-label">Nombre</label>
                    <input type="text" id="add-order-name" class="form-control" placeholder="Nombre" required>
                </div>
                <div class="col-md-6">
                    <label for="add-order-lastname" class="form-label">Apellido</label>
                    <input type="text" id="add-order-lastname" class="form-control" placeholder="Apellido" required>
                </div>
                <div class="col-md-6">
                    <label for="add-order-total" class="form-label">Monto Total</label>
                    <input type="number" id="add-order-total" class="form-control" placeholder="Monto Total" required step="0.01">
                </div>
                <div class="col-md-6">
                    <label for="add-order-status" class="form-label">Estado</label>
                    <input type="text" id="add-order-status" class="form-control" placeholder="Estado" required>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">Agregar Pedido</button>
                </div>
            </form>
        </div>

        <!-- Tabla de pedidos -->
        <div class="card p-4">
            <h2 class="h5 mb-3">Lista de Pedidos</h2>
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Estado</th>
                        <th>Monto Total</th>
                        <th>Fecha de Creación</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="order-table-body">
                    <!-- Filas dinámicas de pedidos -->
                </tbody>
            </table>
        </div>

        <!-- Formulario para editar un pedido -->
        <div id="edit-order-section" class="card p-4 mt-4" style="display:none;">
            <h2 class="h5">Editar Pedido</h2>
            <form id="edit-order-form" class="row g-3">
                <div class="col-md-6">
                    <label for="edit-order-id" class="form-label">ID del Pedido</label>
                    <input type="text" id="edit-order-id" class="form-control" readonly>
                </div>
                <div class="col-md-6">
                    <label for="edit-order-name" class="form-label">Nombre</label>
                    <input type="text" id="edit-order-name" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label for="edit-order-lastname" class="form-label">Apellido</label>
                    <input type="text" id="edit-order-lastname" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label for="edit-order-status" class="form-label">Estado</label>
                    <input type="text" id="edit-order-status" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <label for="edit-order-total" class="form-label">Monto Total</label>
                    <input type="number" id="edit-order-total" class="form-control" required step="0.01">
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-success">Guardar Cambios</button>
                    <button type="button" class="btn btn-secondary" onclick="hideEditOrderSection()">Cancelar</button>
                </div>
            </form>
        </div>

        <!-- Mensaje de éxito o error -->
        <div id="message" class="mt-4"></div>
    </div>

    <script>
        $(document).ready(function() {
            loadOrders();

            // Cargar pedidos desde la API
            function loadOrders() {
                $.ajax({
                    url: 'http://localhost:8001/api/pedidos/',
                    type: 'GET',
                    success: function(response) {
                        const orderTableBody = $('#order-table-body');
                        orderTableBody.empty(); // Limpia la tabla antes de cargar los pedidos

                        response.pedidos.forEach(order => {
                            orderTableBody.append(`
                                <tr>
                                    <td>${order.id}</td>
                                    <td>${order.nombre}</td>
                                    <td>${order.apellido}</td>
                                    <td>${order.estado}</td>
                                    <td>${order.monto_total}</td>
                                    <td>${order.created_at}</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm" onclick="editOrder(${order.id}, '${order.nombre}', '${order.apellido}', '${order.estado}', ${order.monto_total})">Editar</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteOrder(${order.id})">Eliminar</button>
                                    </td>
                                </tr>
                            `);
                        });
                    },
                    error: function(xhr, status, error) {
                        $('#message').text('Error al cargar los pedidos: ' + error).addClass('alert alert-danger');
                    }
                });
            }

            // Agregar un nuevo pedido
            $('#add-order-form').on('submit', function(e) {
                e.preventDefault();
                const orderData = {
                    nombre: $('#add-order-name').val(),
                    apellido: $('#add-order-lastname').val(),
                    monto_total: $('#add-order-total').val(),
                    estado: $('#add-order-status').val()
                };

                $.ajax({
                    url: 'http://localhost:8001/api/pedidos/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(orderData),
                    success: function(response) {
                        $('#message').text('Pedido agregado exitosamente').addClass('alert alert-success');
                        loadOrders(); // Recargar los pedidos después de agregar uno
                        $('#add-order-form')[0].reset(); // Reiniciar el formulario
                    },
                    error: function(xhr, status, error) {
                        $('#message').text('Error al agregar el pedido: ' + error).addClass('alert alert-danger');
                    }
                });
            });

            // Función para editar un pedido
            window.editOrder = function(id, nombre, apellido, estado, total) {
                $('#edit-order-id').val(id);
                $('#edit-order-name').val(nombre);
                $('#edit-order-lastname').val(apellido);
                $('#edit-order-status').val(estado);
                $('#edit-order-total').val(total);
                $('#edit-order-section').show();
            }

            // Función para ocultar la sección de edición
            window.hideEditOrderSection = function() {
                $('#edit-order-section').hide();
            }

            // Guardar cambios en la edición de un pedido
            $('#edit-order-form').on('submit', function(e) {
                e.preventDefault();
                const orderId = $('#edit-order-id').val();
                const updatedOrder = {
                    nombre: $('#edit-order-name').val(),
                    apellido: $('#edit-order-lastname').val(),
                    monto_total: $('#edit-order-total').val(),
                    estado: $('#edit-order-status').val()
                };

                $.ajax({
                    url: `http://localhost:8001/api/pedidos/${orderId}/`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(updatedOrder),
                    success: function(response) {
                        $('#message').text('Pedido actualizado exitosamente').addClass('alert alert-success');
                        loadOrders();
                        hideEditOrderSection(); // Ocultar la sección de edición
                    },
                    error: function(xhr, status, error) {
                        $('#message').text('Error al actualizar el pedido: ' + error).addClass('alert alert-danger');
                    }
                });
            });

            // Eliminar un pedido
            window.deleteOrder = function(id) {
                if (confirm('¿Estás seguro de eliminar este pedido?')) {
                    $.ajax({
                        url: `http://localhost:8001/api/pedidos/${id}/`,
                        type: 'DELETE',
                        success: function(response) {
                            $('#message').text('Pedido eliminado exitosamente').addClass('alert alert-success');
                            loadOrders();
                        },
                        error: function(xhr, status, error) {
                            $('#message').text('Error al eliminar el pedido: ' + error).addClass('alert alert-danger');
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>
